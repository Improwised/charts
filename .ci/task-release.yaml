---
platform: linux
image_resource: { type: docker-image, source: { repository: quay.io/helmpack/chart-testing, tag: v3.3.1 }}

inputs:
- name: repo
- name: charts

outputs:
- name: charts
  path: charts
run:
  path: bash
  args:
  - -cxe
  - |
    cd repo
    git config remote.origin.fetch refs/heads/*:refs/remotes/origin/*
    git fetch --all
    [[ "" == $(ct list-changed --config ct.yaml) ]] && echo "########### no changes found ###########" && exit 0
    git config --global user.email concourse@github-noreply.com
    git config --global user.name concourse
    printf "packaging chart"
    export HELM_CONFIG_HOME=./
    for chart in $(ct list-changed); do
      echo "Building Chart $chart"
      helm dependency build $chart
      helm package $chart
    done
    mv *.tgz ../charts/charts/
    cd ../charts
    ls
    helm repo index --url https://improwised.github.io/charts .
    cat index.yaml
    git add .
    git commit -m "releases $(date '+%Y-%m-%d-%H-%M-%S')" --allow-empty
