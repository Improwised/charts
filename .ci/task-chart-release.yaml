---
platform: linux
# image_resource: { type: docker-image, source: { repository: alpine } }

inputs:
  - name: repo

run:
  path: bash
  args:
    - -cx
    - |
      ## RELEASE
      set -e
      TASK_ROOT=$(pwd)
      [[ ${CHARTCSV} == "NO" ]] && exit 0

      echo ${CHARTCSV} | base64 -d >bumping
      tarr https://github.com/tcnksm/ghr/releases/download/v0.13.0/ghr_v0.13.0_linux_amd64.tar.gz ghr_v0.13.0_linux_amd64/ghr /usr/bin/ghr
      tarr https://github.com/git-chglog/git-chglog/releases/download/v0.14.2/git-chglog_0.14.2_linux_amd64.tar.gz git-chglog /usr/local/bin/git-chglog
      git config --global user.email concourse@github-noreply.com
      git config --global user.name concourse

      PROJECT_USERNAME=$(git config --get remote.origin.url | sed 's/git\@github\.com\:\|\.git\|https\:\/\/github\.com\///g' | awk -F\/ '{printf $1}')
      PROJECT_REPONAME=$(git config --get remote.origin.url | sed 's/git\@github\.com\:\|\.git\|https\:\/\/github\.com\///g' | awk -F\/ '{printf $2}')

      cd repo
      while read -r line; do
        CHART=($line)
        echo "Packaging ${CHART[0]}"
        CHART_NAME=${CHART[0]/charts\//}
        OLD_VERSION=${CHART[1]}
        NEW_VERSION=${CHART[2]}
        COMMIT_SHA=${CHART[3]}

        git tag ${CHART_NAME}-${NEW_VERSION} ${COMMIT_SHA}
        git-chglog -o /tmp/${CHART_NAME}-${NEW_VERSION}.md \
          --config .ci/config.yml \
          --path ${CHART} \
          ${CHART_NAME}-${OLD_VERSION}..${CHART_NAME}-${NEW_VERSION}
        git tag -d ${CHART_NAME}-${NEW_VERSION}

        echo "Releasing ${CHART_NAME}"
        echo ghr -token "${GITHUB_TOKEN}" \
          -name "${CHART_NAME}-${NEW_VERSION}" \
          -body "$(cat /tmp/${CHART_NAME}-${NEW_VERSION}.md)" \
          -owner "${PROJECT_USERNAME}" \
          -repository "${PROJECT_REPONAME}" \
          -commitish "${COMMIT_SHA}" \
          -replace \
          ${CHART_NAME}-${NEW_VERSION}


      done <${TASK_ROOT}/bumping
