---
platform: linux

inputs:
  - name: repo
  - name: charts
outputs:
  - name: charts
    path: charts

run:
  path: bash
  args:
    - -cx
    - |
      set -e
      [[ ! -f repo/bumping ]] && exit 0
      TASK_ROOT=$(pwd)

      ## Git fetchhing
      cd charts
      git config remote.origin.fetch refs/heads/*:refs/remotes/origin/*
      git fetch --all
      cd ..
      cd repo
      git config remote.origin.fetch refs/heads/*:refs/remotes/origin/*
      git fetch --all

      export HELM_CONFIG_HOME=$(pwd)/

      while read -r line; do
        CHART=($line)
        echo "Packaging ${CHART[0]}"
        helm package -u -d ${TASK_ROOT}/charts/charts ${CHART[0]}

        cd ${TASK_ROOT}/charts
        helm repo index --url https://improwised.github.io/charts .
        git show
        git add .
        git commit -m "${CHART[0]}: ${CHART[1]} â†’ ${CHART[2]}"

        cd ${TASK_ROOT}/repo
      done <bumping
      set +e
      rm bumping*
